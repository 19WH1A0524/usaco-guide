---
id: cf-1666F
source: CF
title: Fancy Stack
author: Aakash Gokhale
---

[Official Editorial (C++)](https://codeforces.com/blog/entry/104763)

## Explanation

**Time Complexity:** $\mathcal{O}(n^2)$


<LanguageSection>
<CPPSection>
```cpp
#include <bits/stdc++.h>

using namespace std;

using ll = long long;

const ll mod = 998244353;

const int MAXN = 5001;
ll f[MAXN];
ll ivf[MAXN];

ll binpow(ll a, ll b) {
  if (b < 0) return 1;
  ll res = 1;
  while (b) {
    if (b & 1) res = (res * a) % mod;
    a = (a * a) % mod;
    b >>= 1;
  }
  return res;
}

void init() {
  f[0] = 1;
  for (ll i = 1; i <= MAXN; i++) {
    f[i] = (f[i - 1] * i) % mod;
  }
  for (ll i = 0; i <= MAXN; i++) {
    ivf[i] = binpow(f[i], mod - 2);
  }
}

ll c(ll a, ll b) {
  if (a < b) return 0;
  return ((f[a] * ivf[b]) % mod * ivf[a - b]) % mod;
}

void solve() {
  int n;
  cin >> n;
  vector<int> a(n);
  for (auto & i: a) cin >> i;
  reverse(a.begin(), a.end());
  vector<pair<int, ll>> b;
  for (int i = 0; i < n; i++) {
    if (b.size() > 0 && b.back().first == a[i]) {
      b.back().second++;
    } else {
      b.push_back({a[i], 1ll});
    }
  }
  // i greatest are used, j are even spots, i - j are odd spots
  ll dp[n + 1][n + 1];
  memset(dp, 0ll, sizeof(dp));
  dp[0][0] = 1; 
  ll size = 0;
  for (int i = 0; i < ((int) b.size()); i++) {
    for (ll j = 0; j <= size; j++) {
      ll positions = max(j - 1, 0ll) + (j == n / 2) - (size - j);
      // k in the even position and b[i].second - k in the odd
      for (ll k = 0; k <= 1; k++) { 
        if (j + k > n / 2) continue;
        dp[size + b[i].second][j + k] = (dp[size + b[i].second][j + k] + c(positions, b[i].second - k) * dp[size][j] % mod) % mod;
      }
    }
    size += b[i].second;
  }
  cout << dp[n][n / 2] << endl;
}

int main() {
  ios::sync_with_stdio(0);
  cin.tie(0);
  init();
  int T = 1;
  cin >> T;
  while (T--) solve();
}

```
</CPPSection>
</LanguageSection>
